---
title: "qbs103proj"
output:  html_document
date: "2025-07-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
library(tidyr)
library(dplyr)
library(janitor)
library(hrbrthemes)
library(ggplot2)
```


```{r}
#load the data
data <- read.csv("QBS103_GSE157103_genes.csv")
meta <- read.csv("QBS103_GSE157103_series_matrix-1.csv")
#head(data)
#head(meta)
```

```{r}
#number of genes
nrow(data)

```

```{r}
#OlD: first attempt at reformatting the data 

#transpose to longer data so participant ID becomes column
data_long <- pivot_longer( data = data,
    cols = -X,  
    names_to = "participant_id",
    values_to = "expression"
  )
#head(data_long)
```

```{r}
# OLD: join data with metadata
mdata <- left_join(data_long, meta, by = "participant_id")
#head(mdata)
```

```{r}
#transpose data so participant id is row, genes are columns
trans <- as.data.frame(t(data))
colnames(trans) <- trans[1,]
trans <- trans[-1,]
#head(trans)
```

```{r}
#select gene of interest: AAMP
aamp<- trans['AAMP']
#create participant_id column based on rownames
aamp$participant_id <- rownames(aamp)
#head(aamp)
```

```{r}
#join AAMP expression per participant with metadata
aampm<- merge(aamp, meta, by = "participant_id")
#from RBlogger, Convert Multiple Columns to Numeric in R
aampm <- aampm %>% mutate_at(c('AAMP'), as.numeric)
aampm$ferritin.ng.ml. <- as.numeric(aampm$ferritin.ng.ml.)
#head(aampm)

```


```{r}
#scatterplot of ferritin and expression
ggplot(aampm, aes(x = AAMP,y = ferritin.ng.ml.)) +
  geom_point() + 
  theme_ipsum() +
  ggtitle("AAMP expression vs. Ferritin Concentration") + 
  
  labs(x = "AAMP expression",
    y = "Ferritin (ng per ml)")+

  theme(
      plot.title = element_text(size=10)
    )+ geom_smooth(method = "lm", se = FALSE, color = "blue")
```
```{r}
ggplot(aampm, aes(x = AAMP)) +
  geom_histogram(fill="#69b3a2", color="#e9ecef", alpha=0.9) + 
  theme_ipsum() +
  ggtitle("AAMP expression levels") + 
  theme(
      plot.title = element_text(size=10)
    )
```


```{r}
#remove row with unknown gender
aampm_filtered <- aampm[aampm$sex != " unknown", ]

#rename factors to proper capitalization
aampm_filtered$mechanical_ventilation <- factor(
  aampm_filtered$mechanical_ventilation,
  levels = c(" no", " yes"),
  labels = c("No", "Yes")
)

aampm_filtered$sex <- factor(
  aampm_filtered$sex,
  levels = c(" male", " female"),
  labels = c("Male", "Female")
)

#Create box plot
ggplot(aampm_filtered,aes(x = mechanical_ventilation,y = AAMP, fill = sex)) +
  geom_boxplot() + 
  theme_ipsum()+ 
  ggtitle(paste('AAMP Expression Across Patients on Mechanical Ventilation'))+
  labs(x = 'Mechanical ventilation?', fill = "Sex")+
  theme(
      plot.title = element_text(size=10)
    )
  
```
```{r}
library(rlang)
```
STARTING TO WRITE FUNCTIONS HERE: 

```{r}
#reformat the given data and metadata to form used in plotting functions
mergeData <- function(gene, numeric, data, metadata) {
  # select gene from data 
  sel <- data[gene]
  sel$participant_id <- rownames(sel)
  
  #merge with metadata 
  selm<- merge(sel, meta, by = "participant_id")
  
  #convert Multiple Columns to Numeric in R, updated with Chatgpt input on way to achieve this that is not deprecated (without mutate_at())
  #access col names using strings with !!sym(Chatgpt)
  selm <- selm %>% 
    mutate(across(c(!!sym(gene), !!sym(numeric)), as.numeric)) %>%
    #remove row with unknown gender
    filter(sex != " unknown")
  return(selm)
}

Fdata <- mergeData("AAMP", "ferritin.ng.ml.", trans, meta)
```
```{r}
head(Fdata)
```

```{r}
genScat <- function(gene, numeric, selm) {
  #selm = data after selected gene and merge
  #gene and numeric are string variables

  #plot gene expression vs. selected numeric
  ggplot(selm, aes(x = !!sym(gene),y = !!sym(numeric))) +
  geom_point() + 
  theme_ipsum() +
  ggtitle(paste(gene, "expression vs.", numeric))+ 

  theme(
      plot.title = element_text(size=10)
    )+ 
    #add line of best fit
    geom_smooth(method = "lm", se = FALSE, color = "blue")
}
```

```{r}
genScat("AAMP", "ferritin.ng.ml.", Fdata)
```
```{r}
# generate boxplot using transposed, merged, filtered, and numeric data
genBox <- function(gene, numeric, cat1, cat2, selm) {
  #selm = data after selecting gene and merged
  #All varialbles passed as strings (gene, numeric, cat1, cat2)
  
  ggplot(selm,aes(x = !!sym(cat1),y = !!sym(gene), fill = !!sym(cat2))) +
  # Add box plot
  geom_boxplot() + 
  theme_ipsum()+ 
  ggtitle(paste(gene, "expression across", cat1, "and", cat2, "patients"))+
  theme(
      plot.title = element_text(size=10)
    )
}
```

```{r}
genBox('AAMP', "ferritin.ng.ml.", "mechanical_ventilation", "sex", Fdata)
```
```{r}
genHist <- function(gene, selm) {
  #selm = data after selecting gene and merged
  #All variables passed as strings (gene)
  
  
  ggplot(selm, aes(x = !!sym(gene))) +
  geom_histogram(fill="#69b3a2", color="#e9ecef", alpha=0.9) + 
  theme_ipsum() +
  ggtitle(paste("Frequency of", gene,"expression levels")) + 
  theme(
      plot.title = element_text(size=10)
    )
}
```

```{r}
genHist("AAMP", Fdata)
```
```{r}
#Edit of Merge Data function to accept list of genes instead of single gene
mergeDatas <- function(genevec, numeric, data, metadata) {
  # select gene from data 
  sel <- data[, genevec]
  sel$participant_id <- rownames(sel)
  
  #merge with metadata 
  selm<- merge(sel, meta, by = "participant_id")
  
  #convert Multiple Columns to Numeric in R, updated with Chatgpt input on way to achieve this that is not deprecated (without mutate_at())
  selm <- selm %>% 
    mutate(across(all_of(c(genevec, numeric)), as.numeric)) %>%
    #remove row with unknown gender
    filter(sex != " unknown")
  return(selm)
}
```


```{r}
#generates all plots using previously defined functions for each type of plot
genAllPlots <- function(genevec, numeric, cat1, cat2, selm) {
  #selm = data after selecting gene and merged
  #genevec is vector of string names of genes
  #Column variables passed as strings (gene)
  
  for (gene in genevec) {
  #generate hist, scat, and box plots for each gene 
    print(genHist(gene, selm))
    print(genScat(gene, numeric, selm))
    print(genBox(gene, numeric , cat1, cat2 , selm))
    }
}

```

```{r}
genes = c("AAMP", "A2M", "A1BG")
multigene_Fdata<- mergeDatas(genes, "ferritin.ng.ml.", trans, meta)
genAllPlots(genes, "ferritin.ng.ml.", "mechanical_ventilation", "sex", multigene_Fdata)
```
NEED CHANGE CAPITALIZATION

PART 3 STARTS HERE:


```{r}
#select genes with most variance

#resolving NA's through removal
variance <- apply(as.matrix(data), 1, var, na.rm = TRUE)
#resolving NAs by placing them last (chatgpt)
heat_genes <- data[order(variance, decreasing = TRUE, na.last = TRUE), , drop = FALSE]
heat_genes <- head(heat_genes, 10)
top10 <- heat_genes$X

#make data
hdata<- mergeDatas(top10, "ferritin.ng.ml.", trans, meta)

hcolumns <- c(top10, 'sex', 'mechanical_ventilation')

#includes categoricals for annotations
hdatae <- hdata %>%
  select(all_of(hcolumns)) %>%
  mutate(across(any_of(top10), ~ as.numeric(as.character(.x))))
#clean factors
hdatae$mechanical_ventilation <- factor(
 hdatae$mechanical_ventilation,
  levels = c(" no", " yes"),
  labels = c("No", "Yes")
)

hdatae$sex <- factor(
  hdatae$sex,
  levels = c(" male", " female"),
  labels = c("Male", "Female")
)

#select top10 genes from merged data and metadata
#only numerics for heatmap 
hdata <- hdata %>%
  select(all_of(top10)) %>%
  mutate(across(any_of(top10), ~ as.numeric(as.character(.x))))

# Log2-normalize data for plotting
hdata[top10] <- lapply(hdata[top10], log2)

#head(hdatae)
```
```{r}
#install.packages('pheatmap')
library(pheatmap)

pheatmap(hdata,
         clustering_distance_cols = 'euclidean',
         clustering_distance_rows = 'euclidean',
         show_rownames = FALSE,
         border_color = NA)
```
```{r}
mat <- hdata #make matrix for heatmap

#annotation data (rownames = col for matrix)
hmeta <- hdatae[, c("sex", "mechanical_ventilation")]
rownames(hmeta) <- rownames(hdatae)   # subject IDs

# ensure rownames align
rownames(mat)   <- rownames(hdatae)          # subjects
hmeta           <- hdatae[, c("sex","mechanical_ventilation")]
rownames(hmeta) <- rownames(hdatae)          # subjects

# Factors
hmeta$sex <- factor(hmeta$sex, levels = c("Male","Female"))
hmeta$mechanical_ventilation <- factor(hmeta$mechanical_ventilation,
                                       levels = c("No","Yes"))

colnames(hmeta) <- c("Sex", "Ventilation")

# Make sure ann_colors keys match (chatgpt debug for annotation error)
ann_colors <- list(
  Sex = c(Male = "steelblue", Female = "tomato"),
  Ventilation = c(No = "darkgreen", Yes = "darkred")
)

pheatmap(mat,
         annotation_row = hmeta,          # âœ… row annotation
         annotation_colors = ann_colors,
         show_rownames = FALSE,
         border_color = NA)

```
```{r}
unique(hmeta$mechanical_ventilation)
```


```{r}
hmeta <- as.data.frame(hmeta)
hmeta <- hmeta[rownames(mat), , drop = FALSE]
names(hmeta) <- c("Sex","Ventilation")  # force simple, known names

hmeta$Sex <- factor(trimws(as.character(hmeta$Sex)), levels = c("Female","Male"))
hmeta$Ventilation <- factor(trimws(as.character(hmeta$Ventilation)), levels = c("No","Yes"))

ann_colors <- list(
  'Sex' = c(Female = "tomato", Male = "steelblue"),
  'Ventilation' = c(No = "darkgreen", Yes = "darkred")
)

pheatmap(
  mat,
  clustering_distance_cols = "euclidean",
  clustering_distance_rows = "euclidean",
  annotation_row = hmeta,
  annotation_colors = ann_colors,
  show_rownames = FALSE,
  border_color = NA
)
```
```{r}
print(colnames(hmeta))
print(names(ann_colors))
lapply(hmeta, levels)
```

```{r}
head(aampm)

# calculate mean AAMP expression by Charlson score
avg_data <- aampm %>%
  group_by(charlson_score) %>%
  summarise(mean_aamp = mean(AAMP, na.rm = TRUE))

# Lollipop chart
ggplot(avg_data, aes(x = charlson_score, y = mean_aamp)) +
  geom_segment(aes(xend = charlson_score, y = 0, yend = mean_aamp), 
               color = "grey") +
  geom_point(color = "red", size = 3) +
  scale_x_continuous(breaks = 0:11) +
  labs(title = "Average AAMP Expression by Charlson Score",
       x = "Charlson Score",
       y = "Average AAMP Expression") +
  theme_ipsum()

head(aampm)

```
```{r}
unique(aampm$charlson_score)
```

```{r}
#format additional columns for summary table
tcols <- c("ferritin.ng.ml.", "procalcitonin.ng.ml..", "age", "ventilator.free_days", "sex", "mechanical_ventilation", "icu_status", "disease_status")
num_cols <- c("ferritin.ng.ml.", "procalcitonin.ng.ml..", "lactate.mmol.l.", "age", "ventilator.free_days")
#select relevant cols, use ~ to safely convert to numeric if there are factors (chatgpt)
tdata <- Fdata %>%
  select(all_of(tcols)) %>%  
  mutate(across(any_of(num_cols), ~ as.numeric(as.character(.x))))
```
```{r}
#check for normality
hist(tdata$lactate.mmol.l.)
#use median since numerics are non-normal (skewed)
```

```{r}
#Next few code blocks checks for summary stats
summary(tdata)
```
```{r}
sd(tdata$age, na.rm = TRUE)
```

```{r}
#Ex. filter on diseased
fild<- tdata %>%
  filter(disease_status == "disease state: non-COVID-19")

summary(fild)

```
```{r}
sd(fild$age, na.rm = TRUE)

```
```{r}
fild %>%
  count(sex)

```
```{r}
hist(fild$ferritin.ng.ml.)
```

```{r}
#generate citations
toBibtex(citation("tidyr"))
toBibtex(citation("dplyr"))
toBibtex(citation("janitor"))
toBibtex(citation("hrbrthemes"))
toBibtex(citation("ggplot2"))
toBibtex(citation("pheatmap"))

```

